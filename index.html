<!DOCTYPE html>
<html lang="en">
 <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>RushResQ - Smart AI & IOT Traffic Management System</title>

    <!-- Favicon -->
    <link rel="icon" href="favicon.jpg" type="image/jpeg" />

    <meta
      name="description"
      content="Request emergency green corridors instantly with RushResQ. AI-powered traffic optimization for faster emergency response and safer cities."
    />
    <meta name="author" content="Team Innovions" />
    <meta
      name="keywords"
      content="emergency corridors, traffic optimization, AI traffic, emergency response, smart cities, IoT traffic systems"
    />

    <meta
      property="og:title"
      content="RushResQ - Smarter Traffic, Faster Rescue"
    />
    <meta
      property="og:description"
      content="AI-powered emergency corridor system for instant traffic optimization and faster emergency response times."
    />
    <meta property="og:type" content="website" />
    <meta
      property="og:image"
      content="https://lovable.dev/opengraph-image-p98pqg.png"
    />

    <meta name="twitter:card" content="summary_large_image" />
    <meta name="twitter:site" content="@lovable_dev" />
    <meta
      name="twitter:image"
      content="https://lovable.dev/opengraph-image-p98pqg.png"
    />

    <!-- ðŸ‘‡ Added CSS to move widget up -->
    <style>
      #vapi-chatbot {
        position: fixed;
        bottom: 80px !important; /* ~2â€“3 cm above screen bottom */
        right: 20px !important;
        width: 350px;
        height: 500px;
        z-index: 9999;
      }
    </style>
  </head>
  <body>
    <!-- Main App Root -->
    <div id="root"></div>

    <!-- Vapi Assistant Widget Container -->
    <div id="vapi-chatbot"></div>

    <!-- If you have a React/TS app, this loads it -->
    <script type="module" src="/src/main.tsx"></script>

    <!-- ðŸ‘‡ Vapi + Google Sheets Integration -->
    <script>
      const assistantId = "387deb3e-5591-425b-a815-34fcf1fb5752"; // ðŸ”¹ Your Vapi Assistant ID
      const apiKey = "6d92c2b5-0061-423a-9097-6ba5963cdec9";       // ðŸ”¹ Your Public API Key

      const buttonConfig = {
        container: "#vapi-chatbot", // Widget will render in this div
      };

      // âœ… Extract Route Number & Emergency Type (supports Hindi + English)
      function extractRouteAndEmergency(message) {
        // Route number (English & Hindi: "Route 7", "à¤°à¥‚à¤Ÿ à¤¨à¤‚à¤¬à¤° 7")
        const routeRegex = /(Route[-\s]?\d+|à¤°à¥‚à¤Ÿ\s*à¤¨à¤‚à¤¬à¤°\s*\d+)/i;
        // Emergency keywords (English + Hindi)
        const emergencyRegex = /(accident|fire|medical|police|rescue|ambulance|emergency|à¤à¤•à¥à¤¸à¥€à¤¡à¥‡à¤‚à¤Ÿ|à¤†à¤—|à¤®à¥‡à¤¡à¤¿à¤•à¤²\s*à¤‡à¤®à¤°à¤œà¥‡à¤‚à¤¸à¥€)/i;

        const routeMatch = message.match(routeRegex);
        const emergencyMatch = message.match(emergencyRegex);

        return {
          route: routeMatch ? routeMatch[0] : null,
          emergency: emergencyMatch ? emergencyMatch[0] : null,
        };
      }

      // âœ… Save to Google Sheet (SheetDB API)
      function saveEmergencyLog(route, emergency) {
        fetch("https://sheetdb.io/api/v1/k4an08y6yqje2", { // ðŸ”¹ Your SheetDB URL
          method: "POST",
          headers: {
            "Content-Type": "application/json",
          },
          body: JSON.stringify({
            data: [
              {
                Timestamp: new Date().toISOString(),
                Route_Number: route || "N/A",
                Emergency_Type: emergency || "N/A",
              },
            ],
          }),
        })
          .then((res) => res.json())
          .then((data) => console.log("âœ… Saved to SheetDB:", data))
          .catch((err) => console.error("âŒ Error saving to SheetDB:", err));
      }

      // âœ… Load Vapi SDK
      (function (d, t) {
        var g = document.createElement(t),
            s = d.getElementsByTagName(t)[0];
        g.src =
          "https://cdn.jsdelivr.net/gh/VapiAI/html-script-tag@latest/dist/assets/index.js";
        g.defer = true;
        g.async = true;
        s.parentNode.insertBefore(g, s);

        g.onload = function () {
          // Initialize floating widget
          if (window.VapiWidget) {
            VapiWidget.init({
              assistantId: assistantId,
              apiKey: apiKey
            });
          }

          // Initialize custom container
          if (window.vapiSDK) {
            window.vapiInstance = window.vapiSDK.run({
              apiKey: apiKey,
              assistant: assistantId,
              config: buttonConfig,
            });

            // Capture user speech-to-text messages
            window.vapiInstance.on("user_message", (event) => {
              const userMessage = event.text;
              console.log("ðŸ—£ User said:", userMessage);

              // Extract route + emergency
              const { route, emergency } = extractRouteAndEmergency(userMessage);
              console.log("ðŸ“Œ Extracted:", route, emergency);

              // Save structured data
              saveEmergencyLog(route, emergency);
            });
          }
        };
      })(document, "script");
    </script>
  </body>
</html>
